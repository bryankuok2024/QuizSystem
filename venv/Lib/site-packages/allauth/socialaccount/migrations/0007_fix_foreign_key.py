# Generated by Django 5.0.6 on 2024-06-06 12:48

from django.db import migrations
from django.conf import settings

# The name of the foreign key constraint that was created incorrectly.
# This was taken directly from the IntegrityError message.
# It might be different on other systems, but it's specific to this database instance.
INCORRECT_CONSTRAINT_NAME = 'socialaccount_socialaccount_user_id_8146e70c_fk_auth_user_id'

# The table for the SocialAccount model
SOCIAL_ACCOUNT_TABLE = 'socialaccount_socialaccount'

# The table for the project's custom user model
USER_TABLE = 'users_customuser' # Hardcoding for clarity as it's the root of the problem

class Migration(migrations.Migration):

    dependencies = [
        ('socialaccount', '0006_alter_socialaccount_extra_data'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        # The old foreign key constraint appears to have been dropped in a
        # previous, messy migration. The current state is that there is NO
        # foreign key constraint on the user_id column.
        # We will now fix the column type and add the correct constraint.

        # Step 1: Modify the column type to match the custom user's PK (BIGINT).
        migrations.RunSQL(
            sql=f"ALTER TABLE `{SOCIAL_ACCOUNT_TABLE}` MODIFY COLUMN `user_id` BIGINT NOT NULL;",
            reverse_sql=f"ALTER TABLE `{SOCIAL_ACCOUNT_TABLE}` MODIFY COLUMN `user_id` INT NOT NULL;"
        ),

        # Step 2: Add the correct foreign key constraint.
        migrations.RunSQL(
            sql=f"ALTER TABLE `{SOCIAL_ACCOUNT_TABLE}` ADD CONSTRAINT `socialaccount_user_id_fk_{USER_TABLE}_id` FOREIGN KEY (`user_id`) REFERENCES `{USER_TABLE}` (`id`);",
            reverse_sql=f"ALTER TABLE `{SOCIAL_ACCOUNT_TABLE}` DROP FOREIGN KEY `socialaccount_user_id_fk_{USER_TABLE}_id`;"
        ),
    ]
